<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Karl Tayeb">
<meta name="dcterms.date" content="2024-02-24">
<meta name="description" content="This document describes different methods for computing important posterior summaries of Bayesain logistic regression: the marginal log likelihood, the posterio mean, and the posterior variance.">

<title>Generalizing the Sum of Single Effects Regression - Bayesian logistic regression with a fixed prior variance</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Generalizing the Sum of Single Effects Regression</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Bayesian logistic regression with a fixed prior variance</h1>
                  <div>
        <div class="description">
          This document describes different methods for computing important posterior summaries of Bayesain logistic regression: the marginal log likelihood, the posterio mean, and the posterior variance.
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Karl Tayeb </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 24, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#todo" id="toc-todo" class="nav-link active" data-scroll-target="#todo">TODO:</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#adaptive-quadrature" id="toc-adaptive-quadrature" class="nav-link" data-scroll-target="#adaptive-quadrature">Adaptive quadrature</a></li>
  <li><a href="#laplace-approximation" id="toc-laplace-approximation" class="nav-link" data-scroll-target="#laplace-approximation">Laplace Approximation</a>
  <ul class="collapse">
  <li><a href="#standard-laplace-approximation" id="toc-standard-laplace-approximation" class="nav-link" data-scroll-target="#standard-laplace-approximation">Standard Laplace approximation</a></li>
  <li><a href="#other-expansion-points" id="toc-other-expansion-points" class="nav-link" data-scroll-target="#other-expansion-points">Other expansion points</a></li>
  <li><a href="#why-expand-at-a-point-other-than-the-mode" id="toc-why-expand-at-a-point-other-than-the-mode" class="nav-link" data-scroll-target="#why-expand-at-a-point-other-than-the-mode">Why expand at a point other than the mode</a></li>
  </ul></li>
  <li><a href="#gauss-hermite-quadrature" id="toc-gauss-hermite-quadrature" class="nav-link" data-scroll-target="#gauss-hermite-quadrature">Gauss-Hermite quadrature</a>
  <ul class="collapse">
  <li><a href="#change-of-variable" id="toc-change-of-variable" class="nav-link" data-scroll-target="#change-of-variable">Change of variable</a></li>
  <li><a href="#relationship-to-the-laplace-approximation" id="toc-relationship-to-the-laplace-approximation" class="nav-link" data-scroll-target="#relationship-to-the-laplace-approximation">Relationship to the Laplace approximation</a></li>
  <li><a href="#discussion-of-efficiency" id="toc-discussion-of-efficiency" class="nav-link" data-scroll-target="#discussion-of-efficiency">Discussion of efficiency</a></li>
  </ul></li>
  <li><a href="#polya-gamma-augmentationjaakkola-jordan" id="toc-polya-gamma-augmentationjaakkola-jordan" class="nav-link" data-scroll-target="#polya-gamma-augmentationjaakkola-jordan">Polya-Gamma Augmentation/Jaakkola-Jordan</a></li>
  <li><a href="#code" id="toc-code" class="nav-link" data-scroll-target="#code">Code</a>
  <ul class="collapse">
  <li><a href="#simulation-functions" id="toc-simulation-functions" class="nav-link" data-scroll-target="#simulation-functions">Simulation functions</a></li>
  <li><a href="#helper-functions" id="toc-helper-functions" class="nav-link" data-scroll-target="#helper-functions">Helper functions</a></li>
  <li><a href="#adaptive-quadrature-1" id="toc-adaptive-quadrature-1" class="nav-link" data-scroll-target="#adaptive-quadrature-1">Adaptive quadrature</a></li>
  <li><a href="#expand-around-mle" id="toc-expand-around-mle" class="nav-link" data-scroll-target="#expand-around-mle">Expand around MLE</a></li>
  <li><a href="#gauss-hermite-code" id="toc-gauss-hermite-code" class="nav-link" data-scroll-target="#gauss-hermite-code">Gauss-Hermite code</a></li>
  <li><a href="#code-for-experiments" id="toc-code-for-experiments" class="nav-link" data-scroll-target="#code-for-experiments">Code for experiments</a></li>
  </ul></li>
  <li><a href="#experiments" id="toc-experiments" class="nav-link" data-scroll-target="#experiments">Experiments</a>
  <ul class="collapse">
  <li><a href="#completely-enriched" id="toc-completely-enriched" class="nav-link" data-scroll-target="#completely-enriched">Completely enriched</a></li>
  <li><a href="#seperable-binary-covariate" id="toc-seperable-binary-covariate" class="nav-link" data-scroll-target="#seperable-binary-covariate">Seperable, binary covariate</a></li>
  <li><a href="#seperable-continuous-covariate" id="toc-seperable-continuous-covariate" class="nav-link" data-scroll-target="#seperable-continuous-covariate">Seperable, continuous covariate</a></li>
  <li><a href="#regular-binary-covariate" id="toc-regular-binary-covariate" class="nav-link" data-scroll-target="#regular-binary-covariate">Regular, binary covariate</a></li>
  <li><a href="#regular-continuous-covariate" id="toc-regular-continuous-covariate" class="nav-link" data-scroll-target="#regular-continuous-covariate">Regular, continuous covariate</a></li>
  <li><a href="#c1-gs66-example" id="toc-c1-gs66-example" class="nav-link" data-scroll-target="#c1-gs66-example">C1-GS66 example</a></li>
  </ul></li>
  <li><a href="#old" id="toc-old" class="nav-link" data-scroll-target="#old">OLD</a>
  <ul class="collapse">
  <li><a href="#gauss-hermite-quadrature-1" id="toc-gauss-hermite-quadrature-1" class="nav-link" data-scroll-target="#gauss-hermite-quadrature-1">Gauss-Hermite Quadrature</a></li>
  <li><a href="#gauss-hermite-at-the-map" id="toc-gauss-hermite-at-the-map" class="nav-link" data-scroll-target="#gauss-hermite-at-the-map">Gauss Hermite at the MAP</a></li>
  <li><a href="#gauss-hermite-approximate-map" id="toc-gauss-hermite-approximate-map" class="nav-link" data-scroll-target="#gauss-hermite-approximate-map">Gauss-Hermite, approximate MAP</a></li>
  <li><a href="#gauss-hermite-at-the-prior" id="toc-gauss-hermite-at-the-prior" class="nav-link" data-scroll-target="#gauss-hermite-at-the-prior">Gauss-Hermite at the prior</a></li>
  </ul></li>
  <li><a href="#dealing-with-the-intercept" id="toc-dealing-with-the-intercept" class="nav-link" data-scroll-target="#dealing-with-the-intercept">Dealing with the intercept</a>
  <ul class="collapse">
  <li><a href="#fixed-intercept" id="toc-fixed-intercept" class="nav-link" data-scroll-target="#fixed-intercept">Fixed intercept</a></li>
  <li><a href="#profile-likelihood" id="toc-profile-likelihood" class="nav-link" data-scroll-target="#profile-likelihood">Profile likelihood</a></li>
  <li><a href="#integrating-over-the-intercept" id="toc-integrating-over-the-intercept" class="nav-link" data-scroll-target="#integrating-over-the-intercept">Integrating over the intercept</a></li>
  <li><a href="#multivariate-gauss-hermite" id="toc-multivariate-gauss-hermite" class="nav-link" data-scroll-target="#multivariate-gauss-hermite">Multivariate Gauss-Hermite</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="todo" class="level2">
<h2 class="anchored" data-anchor-id="todo">TODO:</h2>
<ul class="task-list">
<li><input type="checkbox" disabled="">show that adaptive scheme is robust to the scaling factor we choose– we just need to be in a few orders of magnitude of <span class="math inline">\(\max \log p(y | x, b)\)</span> for adaptive quadrature to work. I.e. we could integrate the likelihood ratio w.r.t the null model and be fine, rather than to the MAP soltn.</li>
<li><input type="checkbox" disabled="">quantify how many evaluations of the likelihood each method takes. MAP, MLE, and MLE-MAP are all basically the same. But it would be good to know how many evaluations adaptive takes, and if the 4 or 5 nodes required for Gauss-Hermite represents a large increase in computational cost.</li>
<li><input type="checkbox" disabled="">write discussion of the different simulation scenarios– basically Laplace at the MAP is working well across the tested scenarios, and we get results that agree with adaptive quadrature with just 4 or 5 nodes. The tightness of JJ depends on the simulation scenario.</li>
<li><input type="checkbox" disabled="">compare the posterior mean and posterior variance estimates for each of the methods also. This is important for GIBSS!</li>
<li><input type="checkbox" disabled="">integrate stuff under old into the document, and put the 2d quadrature stuff into a separate document so that this is just about a fixed intercept.</li>
</ul>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>Here we consider logistic regression with a single covariate and fixed intercept. <span class="math inline">\(\tau\)</span> is a fixed prior precision.</p>
<p><span class="math display">\[\begin{align}
y_i | x_i, b_0 \sim \text{Bernoulli}(\sigma(b_0 + bx_9)) \\
b \sim N(0, \tau^{-1})
\end{align}\]</span></p>
<p>Where <span class="math inline">\(\sigma(x) = (1 + \exp(-x))^{-1}\)</span> is the sigmoid funciton. Our goal is to compute the marginal likelihood, the posterior mean, and the posterior variance (actually we don’t need the variance…)</p>
<p><span class="math display">\[\begin{align}
p(y | X) &amp;= \int \prod p(y_i | x_i, b) p(b) db \\
\mu_{\text{post}} &amp;= \int b \; p(b | y, X) \\
\sigma^2_{\text{post}} &amp;= \int b^2 p(b | y, X) - \mu_{\text{post}}^2
\end{align}\]</span></p>
<p>The integrals cannot be computed in closed form, so we rely on numerical integration or approximation.</p>
</section>
<section id="adaptive-quadrature" class="level2">
<h2 class="anchored" data-anchor-id="adaptive-quadrature">Adaptive quadrature</h2>
<p>We can use an adaptive quadrature scheme to compute the marginal likelihood, posterior mean, and posterior variance for our problem.</p>
<p>The unnormalized likelihoods can be exceedingly small, especially for large data samples. In order to make the likelihood <span class="math inline">\(h(x) = f(x)/\max_x(f(x))\)</span> <span class="math inline">\(\int f(x)dx = \max_x(f(x)) \int h(x)dx\)</span>. Applying our quadrature rule to the integral on the right avoids underflow issues.</p>
<p>In order to perform the 1d quadrature we need two things: (1) the fixed intercept and (2) a number of order <span class="math inline">\(\max_x(f(x))\)</span> to normalize by. Both of these are provided by the MAP estimate.</p>
<p>Note: if we were to pursue a 2d quadrature where we integrate over the intercept rather than fixing it, we might get away with normalizing by the likelihood at <span class="math inline">\(\beta=0\)</span>. The null model is easy to fit, (and when we turn our attention to fitting the SER we will see that this computation can be done once per SER)</p>
<p>At the end of the day we want to avoid using the adaptive quadrature scheme. It can involve many evaluations of the likelihood which is expensive. The goal of this document is to find a fast, cheap, stable method for approximating this more precise, but computationally demanding approach.</p>
</section>
<section id="laplace-approximation" class="level2">
<h2 class="anchored" data-anchor-id="laplace-approximation">Laplace Approximation</h2>
<section id="standard-laplace-approximation" class="level3">
<h3 class="anchored" data-anchor-id="standard-laplace-approximation">Standard Laplace approximation</h3>
<p>The Laplace approximation takes a quadratic approximation of the log-integrand. So to approximation <span class="math inline">\(\int \exp f(x) dx\)</span> we would consider the quadratic approximation <span class="math inline">\(\hat f(x; x_0) = f(x_0) + \nabla f(x_0) (x - x_0) + \frac{1}{2}(x - x_0)^T \nabla^2f(x_0) (x - x_0)\)</span>. We will write <span class="math inline">\(\hat f(x) = \hat f(x; x^*)\)</span> where <span class="math inline">\(x*\)</span> is the mode of <span class="math inline">\(f\)</span>. In this case <span class="math inline">\(\nabla f(x^*) =0\)</span> and the first order term is eliminated. Write <span class="math inline">\(\Lambda = -\nabla^2f(x^*)\)</span> the approximation can be identified as a Gaussian integral</p>
<p><span class="math display">\[
\begin{align}
\int \exp f(x) \approx \int \exp \hat f(x) dx = \exp f(x^*) (2\pi)^{p/2}|\Lambda|^{-\frac{1}{2}}
\end{align}
\]</span></p>
<p>In the univariate case this simplifies to <span class="math display">\[
\begin{align}
\int \exp f(x) \approx \int \exp \hat f(x) dx = \exp f(x^*) \sqrt{\frac{2\pi}{\lambda}}
\end{align}
\]</span> where <span class="math inline">\(\lambda = -\frac{d^2}{dx^2}f(x)\vert_{x= x^*}\)</span></p>
<p>To make this explicit for our case, we make</p>
<p><span class="math display">\[\begin{align}
f(b)
&amp;= \log p(y | b) + \log p(b) \\
&amp;= \sum y_i (x_i b) - \log (1 + \exp(x_i b)) - \frac{\tau}{2} b^2 + 0.5 \times \log(\frac{\tau}{2 \pi})
\end{align}\]</span></p>
<p>We compute the MAP <span class="math inline">\(b^* = \arg\max_b f(b)\)</span> and then <span class="math inline">\(\frac{d^2}{db^2} f(b) = \sum_i \sigma(x_ib)\sigma(-x_i b) x_i^2\)</span> to yield the Laplace approximation.</p>
</section>
<section id="other-expansion-points" class="level3">
<h3 class="anchored" data-anchor-id="other-expansion-points">Other expansion points</h3>
<p>We discuss other Laplace type approximations. The general idea is to decompose <span class="math inline">\(f(x) = g(x) + Q(x)\)</span> where <span class="math inline">\(Q\)</span> is quadratic, then rather than making a Taylor approximation to <span class="math inline">\(f\)</span> directly, we can make a Taylor approximation of <span class="math inline">\(g\)</span>, and combine it with <span class="math inline">\(Q\)</span>. In our case we might pick <span class="math inline">\(g(b) = \log p(y | X, b)\)</span> and <span class="math inline">\(Q(b) = \log \phi(b; 0, \tau^{-1})\)</span>. In this case we would expand <span class="math inline">\(g\)</span> around the MLE <span class="math inline">\(\hat b\)</span>:</p>
<p><span class="math display">\[\begin{align}
\int \exp f(b) db
&amp;= \int \exp (g(b) + Q(b)) db \\
&amp;\approx \int \exp \hat g(b) \phi(b; 0, \tau^{-1})) db \\
&amp;= \exp g(\hat b) (\frac{2\pi}{\nu})^{\frac{1}{2}} \int \phi(\hat b; b, \nu^{-1}) \phi(b; 0, \tau^{-1})db\\
&amp;= \exp g(\hat b) (\frac{2\pi}{\nu})^{\frac{1}{2}} \phi(\hat b; 0, \nu^{-1} + \tau^{-1})
\end{align}\]</span></p>
<p>Where we recognize that the convolution of Gaussians is Gaussian with the sum of the variances.</p>
<p>This approximation comes with a natural estimate of the posterior mean and variance, <span class="math inline">\(\mu = \frac{\nu}{\nu + \tau} \hat \beta\)</span> and <span class="math inline">\(\sigma^2 = (\nu + \tau)^{-1}\)</span>.</p>
<p>We might also consider the choice</p>
<p><span class="math display">\[\begin{align}
g(b) = \log p(y | X, b) - \log \phi(b; 0, \tau_2^{-1}), \\
Q(b) = \log \phi(b; 0, \tau^{-1}) + \log \phi(b; 0, \tau_2^{-1}).
\end{align}\]</span></p>
<p>For <span class="math inline">\(\tau_2\)</span> small, this might be a good alternative to expanding around the MLE, as we can be assured that the MAP always exists. However, this is probably not a good choice for <span class="math inline">\(\tau_2 &gt;&gt; \tau\)</span>.</p>
</section>
<section id="why-expand-at-a-point-other-than-the-mode" class="level3">
<h3 class="anchored" data-anchor-id="why-expand-at-a-point-other-than-the-mode">Why expand at a point other than the mode</h3>
<p>This approach is less relevant when we consider a fixed prior, because it is not harder to compute the MAP than it is to compute the MLE. However, it is of interest how accurate these approximations are across a range of prior variances. If the approximation is good, it provides an inexpensive way of tuning the prior variance– the approximate likelihood can be computed with a single evaluation of the Gaussian density function, rather than re-optimizing for each value of <span class="math inline">\(\tau^{-1}\)</span>. Note: even if we can use this approach to select <span class="math inline">\(\tau\)</span>, it is probably wise to compute a more accurate approximation of the marginal likelihood, posterior mean, and posterior variance once <span class="math inline">\(\tau\)</span> is fixed.</p>
</section>
</section>
<section id="gauss-hermite-quadrature" class="level2">
<h2 class="anchored" data-anchor-id="gauss-hermite-quadrature">Gauss-Hermite quadrature</h2>
<p>Gauss-Hermite quadrature is a useful technique for numerical computations of integrals of the form</p>
<p><span class="math display">\[\begin{align}
\int f(x) \exp(-\frac{1}{2} x^2) = \sqrt{2 \pi} \mathbb E_{N(0, 1)}[f(X)]
\end{align}\]</span></p>
<p>The quadrature rule is given by:</p>
<p><span class="math display">\[\begin{align}
\int f(x) \exp(-\frac{1}{2} x^2) = \sum_i^m f(x_i) w_i
\end{align}\]</span></p>
<p>Where <span class="math inline">\((x_i)_{i=1}^m\)</span> are the roots of the <span class="math inline">\(m\)</span>-th Hermite polynomial. The corresponding weights <span class="math inline">\(w\)</span> can be naively determined by solving a system of equations <span class="math inline">\(Aw = b\)</span> where <span class="math inline">\(A\)</span> is a matrix giving the evaluation of <span class="math inline">\(m\)</span> functions <span class="math inline">\((f_i)_{i=1}^m\)</span> at <span class="math inline">\((x_i)_{i=1}^m\)</span> and <span class="math inline">\(b\)</span> are there integrals <span class="math inline">\(F_i = \int f_i(x) e^{-x^2}\)</span> (there are more efficient ways to compute the weights, the point is that quadrature rules are essentially determined by their choice of evaluation points and weight function). The <span class="math inline">\(f_i\)</span> must be polynomials of degree <span class="math inline">\(2m+1\)</span>, and the <span class="math inline">\(m\)</span> point quadrature rule is exact for all polynomials degree <span class="math inline">\(\leq 2m+1\)</span>, (why <span class="math inline">\(2m+1\)</span>? consider that <span class="math inline">\(f_i = \sum_{i=0}^{2m} a_ix^i\)</span> the even terms get killed in the integral).</p>
<section id="change-of-variable" class="level3">
<h3 class="anchored" data-anchor-id="change-of-variable">Change of variable</h3>
<p>A simple change of variable let’s us use Gauss-Hermite quadrature to approximate expectations with respect to <span class="math inline">\(N(\mu, \sigma^2)\)</span></p>
</section>
<section id="relationship-to-the-laplace-approximation" class="level3">
<h3 class="anchored" data-anchor-id="relationship-to-the-laplace-approximation">Relationship to the Laplace approximation</h3>
<p>If we take <span class="math inline">\(\mu = b^*\)</span> and <span class="math inline">\(\sigma = \sqrt{\frac{1}{\lambda}}\)</span> the <span class="math inline">\(1\)</span>-point Gauss-Hermite quadrature is equivalent to the Laplace approximation.</p>
</section>
<section id="discussion-of-efficiency" class="level3">
<h3 class="anchored" data-anchor-id="discussion-of-efficiency">Discussion of efficiency</h3>
<p>To compute the integral <span class="math inline">\(\int g(x) dx\)</span> using Gauss-Hermite quadrature we will factor out a Gaussian density <span class="math inline">\(\int \frac{g(x)}{\phi(x; \mu, \sigma^2)} \phi(x; \mu, \sigma^2)\)</span>. We see that there is a choice in which Gaussian density to factor out. The <span class="math inline">\(m\)</span> point quadrature rule is exact for <span class="math inline">\(h(x) = \frac{g(x)}{\phi(x; \mu, \sigma^2)}\)</span> a polynomial of degree <span class="math inline">\(\leq 2m+1\)</span>. For our quadrature to be accurate we want <span class="math inline">\(h(x)\)</span> to be well approximated by a low-degree polynomial. In particular, we care that the approximation is good in the regions of <span class="math inline">\(\mathbb R\)</span> that contribute most to the integral.</p>
<p>Integrals of this form a common in statistical applications.</p>
<p><span class="citation" data-cites="liuNoteGaussHermite1994">(<a href="#ref-liuNoteGaussHermite1994" role="doc-biblioref">LIU and PIERCE 1994</a>)</span> <span class="citation" data-cites="jackelNoteMultivariateGaussHermite">(<a href="#ref-jackelNoteMultivariateGaussHermite" role="doc-biblioref">Jäckel, n.d.</a>)</span></p>
</section>
</section>
<section id="polya-gamma-augmentationjaakkola-jordan" class="level2">
<h2 class="anchored" data-anchor-id="polya-gamma-augmentationjaakkola-jordan">Polya-Gamma Augmentation/Jaakkola-Jordan</h2>
<p>This is the standard variational approximation for logistic regression first introdced by Jaakola and Jordan. The develop a family of quadratic lower bounds to the binomial log likelihood <span class="citation" data-cites="jaakkolaVariationalApproachBayesian">(<a href="#ref-jaakkolaVariationalApproachBayesian" role="doc-biblioref">Jaakkola and Jordan, n.d.</a>)</span>. This approximation has an interpretation as a mean-field variational approximation to the Polya-Gamma augmented model, where the parameter <span class="math inline">\(\xi\)</span> that indexes the family of quadratic bounds corresponds to the variational approximation for the latent variable.</p>
<p>Using the variational approximation is appealing because it presents few issues when it comes to dealing with a prior on the variance. The evidence lower bound gives a lower bound on the marginal log likelihood. While variational approximations are known to underestimate the posterior variance, we do not need the posterior variance for variable selection using GIBSS.</p>
<p>Implemented in <code>logisticsusie::fit_univariate_vb</code></p>
</section>
<section id="code" class="level2">
<h2 class="anchored" data-anchor-id="code">Code</h2>
<section id="simulation-functions" class="level3">
<h3 class="anchored" data-anchor-id="simulation-functions">Simulation functions</h3>
<p>This creates the SER simulation that we’ve been working with. We simulate 3 enriched gene sets from mSigDB C1 on a background of 5000 genes. When the number of genes is small like this it is not uncommon to have completely enriched gene sets (that is, where <span class="math inline">\(\{i: x_i = 1\} \subseteq \{i: y_i = 1\}\)</span>.</p>
<div class="cell" data-hash="index_cache/html/c1-example_676821a93a602e55b3d4cffe3aae8283">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">##### Minimal working example</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">''</span>, <span class="fu">Sys.glob</span>(<span class="st">'cache/resources/C1*'</span>)) <span class="co"># clear cash so it can knit</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">file.exists</span>(f)){<span class="fu">file.remove</span>(f)}</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>make_c1_sim <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">##### Minimal working example</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  c1 <span class="ot">&lt;-</span> gseasusie<span class="sc">::</span><span class="fu">load_msigdb_geneset_x</span>(<span class="st">'C1'</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sample random 5k background genes</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  background <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">rownames</span>(c1<span class="sc">$</span>X), <span class="dv">5000</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sample GSs to enrich, picked b0 so list is ~ 500 genes</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  enriched_gs <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">colnames</span>(c1<span class="sc">$</span>X), <span class="dv">3</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  b0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">2.2</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="sc">*</span><span class="fu">abs</span>(<span class="fu">rnorm</span>(<span class="fu">length</span>(enriched_gs)))</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  logit <span class="ot">&lt;-</span> b0 <span class="sc">+</span> (c1<span class="sc">$</span>X[background, enriched_gs] <span class="sc">%*%</span> b)[,<span class="dv">1</span>]</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="fu">length</span>(logit), <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>logit)))</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  list1 <span class="ot">&lt;-</span> background[y1<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> c1<span class="sc">$</span>X[background,]</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> X[, Matrix<span class="sc">::</span><span class="fu">colSums</span>(X) <span class="sc">&gt;</span> <span class="dv">1</span>]</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">colnames</span>(X) <span class="sc">%in%</span> enriched_gs)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">X =</span> X, <span class="at">y =</span> y1, <span class="at">o =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(y1)), <span class="at">idx =</span> idx, <span class="at">b =</span> b, <span class="at">b0 =</span> b0, <span class="at">logits=</span>logit)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We look at a few other edgecases: complete enrichment, complete separation (for both binary and continuous <span class="math inline">\(x\)</span>), and regular simulations (for both binary and continuous <span class="math inline">\(x\)</span>).</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-1_71d67eca1ec1cebdfe3738e47c010224">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># "completely enriched"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sim1 <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n=</span><span class="dv">500</span>){</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.2</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.7</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  y[x <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  ll0 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">dbinom</span>(y, <span class="dv">1</span>, <span class="fu">mean</span>(y), <span class="at">log=</span>T))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">ll0 =</span> ll0, <span class="at">o =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(y))))</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># "completely separated, binary x"</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>sim2 <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n=</span><span class="dv">500</span>){</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.2</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> x</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  ll0 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">dbinom</span>(y, <span class="dv">1</span>, <span class="fu">mean</span>(y), <span class="at">log=</span>T))</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">ll0 =</span> ll0, <span class="at">o =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(y))))</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># "completely separated, continuous x"</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>sim3 <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n=</span><span class="dv">500</span>){</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">3</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(x <span class="sc">&gt;</span> <span class="fl">1.5</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  ll0 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">dbinom</span>(y, <span class="dv">1</span>, <span class="fu">mean</span>(y), <span class="at">log=</span>T))</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">ll0 =</span> ll0, <span class="at">o =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(y))))</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co"># "regular simulation, binary x"</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>sim4 <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n=</span><span class="dv">500</span>){</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.2</span>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  logit <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> x</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  prob <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>logit))</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, prob)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  ll0 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">dbinom</span>(y, <span class="dv">1</span>, <span class="fu">mean</span>(y), <span class="at">log=</span>T))</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">ll0 =</span> ll0, <span class="at">o =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(y))))</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="co"># "regular simulation, continuous x"</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>sim5 <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n=</span><span class="dv">500</span>){</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  logit <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> x</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  prob <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>logit))</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, prob)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  ll0 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">dbinom</span>(y, <span class="dv">1</span>, <span class="fu">mean</span>(y), <span class="at">log=</span>T))</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">ll0 =</span> ll0, <span class="at">o =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(y))))</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="co"># "c1-GS66 example</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>sim6 <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n=</span><span class="dv">500</span>){</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  sim <span class="ot">&lt;-</span> <span class="fu">make_c1_sim</span>()</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> sim<span class="sc">$</span>X[,<span class="dv">66</span>]</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> sim<span class="sc">$</span>y</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>  ll0 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">dbinom</span>(y, <span class="dv">1</span>, <span class="fu">mean</span>(y), <span class="at">log=</span>T))</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">ll0 =</span> ll0, <span class="at">o =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(y))))</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="helper-functions" class="level3">
<h3 class="anchored" data-anchor-id="helper-functions">Helper functions</h3>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-2_03729e59c0e2b1392c56f130a2f0a736">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>logsumexp <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  C <span class="ot">&lt;-</span> <span class="fu">max</span>(x)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(C <span class="sc">+</span> <span class="fu">log</span>(<span class="fu">sum</span>(<span class="fu">exp</span>(x <span class="sc">-</span> C))))</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>Diff <span class="ot">&lt;-</span> <span class="cf">function</span>(f, g){<span class="fu">Vectorize</span>(<span class="cf">function</span>(b){<span class="fu">f</span>(b) <span class="sc">-</span> <span class="fu">g</span>(b)})}</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>Sum <span class="ot">&lt;-</span> <span class="cf">function</span>(f, g){<span class="fu">Vectorize</span>(<span class="cf">function</span>(b){<span class="fu">f</span>(b) <span class="sc">+</span> <span class="fu">g</span>(b)})}</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>Exp <span class="ot">&lt;-</span> logisticsusie<span class="sc">:::</span>Exp</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>Shift <span class="ot">&lt;-</span> logisticsusie<span class="sc">:::</span>Shift</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>Prod <span class="ot">&lt;-</span> <span class="cf">function</span>(f, g){<span class="fu">Vectorize</span>(<span class="cf">function</span>(b) <span class="fu">f</span>(b) <span class="sc">*</span> <span class="fu">g</span>(b))}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="adaptive-quadrature-1" class="level3">
<h3 class="anchored" data-anchor-id="adaptive-quadrature-1">Adaptive quadrature</h3>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-3_7148703989a2044b9bdd2ad053edfe81">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' note argument alpha, lets us scale the scaling factor-- make sure rults are not too dependent on logp at the MAP...</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>adaptive <span class="ot">&lt;-</span> <span class="cf">function</span> (x, y, <span class="at">o =</span> <span class="cn">NULL</span>, <span class="at">prior_variance =</span> <span class="dv">1</span>, <span class="at">eps =</span> <span class="dv">0</span>, <span class="at">width =</span> <span class="cn">Inf</span>, <span class="at">alpha=</span><span class="dv">1</span>) {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    ridgefit <span class="ot">&lt;-</span> logisticsusie<span class="sc">:::</span><span class="fu">ridge</span>(x, y, o, prior_variance)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    f <span class="ot">&lt;-</span> logisticsusie<span class="sc">:::</span><span class="fu">make_log_joint_ridge</span>(x, y, o, ridgefit)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    range <span class="ot">&lt;-</span> <span class="fu">with</span>(ridgefit, {</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        s <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(tau0)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(eps <span class="sc">+</span> mu <span class="sc">-</span> width <span class="sc">*</span> s, eps <span class="sc">+</span> mu <span class="sc">+</span> width <span class="sc">*</span> s)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    lower <span class="ot">&lt;-</span> range[<span class="dv">1</span>]</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    upper <span class="ot">&lt;-</span> range[<span class="dv">2</span>]</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (lower <span class="sc">&gt;</span> ridgefit<span class="sc">$</span>mu <span class="sc">|</span> upper <span class="sc">&lt;</span> ridgefit<span class="sc">$</span>mu) {</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">"MAP is not in the integration interval"</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    C <span class="ot">&lt;-</span> <span class="fu">f</span>(ridgefit<span class="sc">$</span>mu) <span class="sc">+</span> <span class="fu">log</span>(alpha)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    f2 <span class="ot">&lt;-</span> <span class="fu">Exp</span>(<span class="fu">Shift</span>(f, C))</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    logZ <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">integrate</span>(f2, lower, upper)<span class="sc">$</span>value) <span class="sc">+</span> C</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    D <span class="ot">&lt;-</span> <span class="fu">exp</span>(C <span class="sc">-</span> logZ)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> <span class="fu">integrate</span>(<span class="cf">function</span>(b) {</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        b <span class="sc">*</span> <span class="fu">f2</span>(b)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    }, lower, upper)<span class="sc">$</span>value <span class="sc">*</span> D</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    mu2 <span class="ot">&lt;-</span> <span class="fu">integrate</span>(<span class="cf">function</span>(b) {</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        b<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">f2</span>(b)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    }, lower, upper)<span class="sc">$</span>value <span class="sc">*</span> D</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    var <span class="ot">&lt;-</span> mu2 <span class="sc">-</span> mu<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mu =</span> mu, <span class="at">var =</span> var, <span class="at">intercept =</span> ridgefit<span class="sc">$</span>intercept, </span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">logZ =</span> logZ))</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="expand-around-mle" class="level3">
<h3 class="anchored" data-anchor-id="expand-around-mle">Expand around MLE</h3>
<p>Here we implement the MLE-based Laplace approximation. We also implement a function that “unshrinks” the MAP estimates at one setting of the prior variance to estimate the mean and variance of the MLE. This is useful because we can then take this approximate MLE and use Laplace-MLE to approximate the posterior summaries under a different setting of the prior variance.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-4_99778c3e237692884ced199c1a70a45f">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute log laplace bf expanded around the MLE</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>compute_laplace_lbf_mle <span class="ot">&lt;-</span> <span class="cf">function</span>(betahat, shat2, lr, prior_variance){</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  tau1 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>shat2</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  tau0 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>prior_variance</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> tau1 <span class="sc">+</span> tau0</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#lbf &lt;- lr + 0.5 * log(tau1/tau) - 0.5  * tau1 * tau0 / tau * betahat^2</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  lbf <span class="ot">&lt;-</span> lr <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">2</span> <span class="sc">*</span> pi<span class="sc">/</span> tau1) <span class="sc">+</span> <span class="fu">dnorm</span>(betahat, <span class="at">mean=</span><span class="dv">0</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(shat2 <span class="sc">+</span> prior_variance))</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(lbf)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' Approximate log bf and posterior with normal approximation expanding about MLE</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>laplace_mle <span class="ot">&lt;-</span> <span class="cf">function</span>(mle, <span class="at">prior_variance=</span><span class="dv">1</span>){</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  mle<span class="sc">$</span>lbf <span class="ot">&lt;-</span> <span class="fu">with</span>(mle, <span class="fu">compute_laplace_lbf_mle</span>(betahat, shat2, lr, prior_variance))</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add approximate posterior to mle</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  tau1 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>mle<span class="sc">$</span>shat2</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  tau0 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>prior_variance</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  mle<span class="sc">$</span>mu <span class="ot">&lt;-</span> tau1<span class="sc">/</span>(tau0 <span class="sc">+</span> tau1) <span class="sc">*</span> mle<span class="sc">$</span>betahat</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  mle<span class="sc">$</span>tau <span class="ot">&lt;-</span> tau1 <span class="sc">+</span> tau0</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  mle<span class="sc">$</span>prior_variance <span class="ot">&lt;-</span> prior_variance</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  mle<span class="sc">$</span>logZ <span class="ot">&lt;-</span> mle<span class="sc">$</span>lbf <span class="sc">+</span> mle<span class="sc">$</span>ll0</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(mle)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co">#' 'unshrink' a l2 regularized fit</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>unshrink <span class="ot">&lt;-</span> <span class="cf">function</span>(fit){</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  nu <span class="ot">&lt;-</span> fit<span class="sc">$</span>tau</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  tau0 <span class="ot">&lt;-</span> fit<span class="sc">$</span>tau0</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> nu <span class="sc">-</span> tau0</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  betahat <span class="ot">&lt;-</span>nu<span class="sc">/</span>tau <span class="sc">*</span> fit<span class="sc">$</span>mu</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  shat2 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>tau</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># approximates the log liklihood under the mle</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">#ll &lt;- fit$ll - 0.5 * log(tau0 / (2 * pi)) + 0.5 * nu*tau0/(nu - tau0) * fit$mu^2</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this it the value of log likelihood that recovers the laplace MAP logZ</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># should agree with formula above but maybe there seemes to be a subtle bug</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>  tau1 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>shat2</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> tau1 <span class="sc">+</span> tau0</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  ll <span class="ot">&lt;-</span> fit<span class="sc">$</span>logZ <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">log</span>(tau1<span class="sc">/</span>tau) <span class="sc">+</span> <span class="fl">0.5</span>  <span class="sc">*</span> tau1 <span class="sc">*</span> tau0 <span class="sc">/</span> tau <span class="sc">*</span> betahat<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>  ll0 <span class="ot">&lt;-</span> fit<span class="sc">$</span>ll0</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  lr <span class="ot">&lt;-</span> ll <span class="sc">-</span> ll0</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">betahat =</span> betahat, <span class="at">shat2 =</span> shat2, <span class="at">intercept=</span>fit<span class="sc">$</span>intercept, <span class="at">ll0 =</span> ll0, <span class="at">ll =</span> ll, <span class="at">lr =</span> lr))</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="co">#' 'unshrink' and 'reshrink'</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>laplace_map <span class="ot">&lt;-</span> <span class="cf">function</span>(fit, <span class="at">prior_variance=</span><span class="dv">1</span>){</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>  unsrhunk <span class="ot">&lt;-</span> <span class="fu">unshrink</span>(fit)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">laplace_mle</span>(unsrhunk, prior_variance))</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="gauss-hermite-code" class="level3">
<h3 class="anchored" data-anchor-id="gauss-hermite-code">Gauss-Hermite code</h3>
<p>Here we implement Gauss-Hermite quadrature for the logistic regression problem. We allow flexibility in specifying <span class="math inline">\(q\)</span>. Our goal generally is to find a robust way to pick <span class="math inline">\(q\)</span> that yields a strong approximation to the marginal likelihood with only a few quadrature points.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-5_67310b714ca0c6830f643d98267acd72">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' gauss-hermite quadrature for \int f(b) db</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' centered on mu, with precision tau</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>gauss_hermite <span class="ot">&lt;-</span> <span class="cf">function</span>(f, mu, tau, ll0, <span class="at">m=</span><span class="dv">9</span>){</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make quadrature points</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  quad_points <span class="ot">&lt;-</span> statmod<span class="sc">::</span><span class="fu">gauss.quad.prob</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    m, <span class="at">dist=</span><span class="st">'normal'</span>, <span class="at">mu=</span>mu, <span class="at">sigma=</span><span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>tau))</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># function logq(b)</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  logq <span class="ot">&lt;-</span> <span class="cf">function</span>(b){</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dnorm</span>(b, <span class="at">mean=</span>mu, <span class="at">sd=</span><span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>tau), <span class="at">log=</span>T) </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute marginal log likelihood</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  h <span class="ot">&lt;-</span> <span class="fu">Diff</span>(f, logq)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute log \int f(b)/q(b) q(b) db</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  logZ <span class="ot">&lt;-</span> <span class="fu">logsumexp</span>(<span class="fu">h</span>(quad_points<span class="sc">$</span>nodes) <span class="sc">+</span> <span class="fu">log</span>(quad_points<span class="sc">$</span>weights))</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  lbf <span class="ot">&lt;-</span> logZ <span class="sc">-</span> ll0</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute posterior mean</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  h1 <span class="ot">&lt;-</span> <span class="fu">Prod</span>(identity, <span class="fu">Exp</span>(<span class="fu">Shift</span>(h, logZ)))</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">h1</span>(quad_points<span class="sc">$</span>nodes) <span class="sc">*</span> quad_points<span class="sc">$</span>weights)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># h2 &lt;- Prod(function(x){x^2}, Exp(Shift(h, logZ)))</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mu2 &lt;- sum(h2(quad_points$nodes) * quad_points$weights)</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  h2 <span class="ot">&lt;-</span> <span class="fu">Sum</span>(<span class="cf">function</span>(x){<span class="dv">2</span> <span class="sc">*</span> <span class="fu">abs</span>(x)}, <span class="fu">Shift</span>(h, logZ))</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  logmu2 <span class="ot">&lt;-</span> <span class="fu">logsumexp</span>(<span class="fu">h2</span>(quad_points<span class="sc">$</span>nodes) <span class="sc">+</span> <span class="fu">log</span>(quad_points<span class="sc">$</span>weights))</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  mu2 <span class="ot">&lt;-</span> <span class="fu">exp</span>(logmu2)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>  var <span class="ot">&lt;-</span> mu2 <span class="sc">-</span> mu<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">lbf =</span> lbf, <span class="at">logZ =</span> logZ, <span class="at">mu=</span>mu, <span class="at">var=</span>var)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>make_log_joint <span class="ot">&lt;-</span> <span class="cf">function</span> (x, y, o, beta0, sigma2) {</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    ll_base <span class="ot">&lt;-</span> <span class="cf">function</span>(beta) {</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>        psi <span class="ot">&lt;-</span> beta0 <span class="sc">+</span> x <span class="sc">*</span> beta <span class="sc">+</span> o</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        ll <span class="ot">&lt;-</span> <span class="fu">sum</span>(psi <span class="sc">*</span> y <span class="sc">-</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(psi))) <span class="sc">+</span> <span class="fu">dnorm</span>(beta, </span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd =</span> <span class="fu">sqrt</span>(sigma2), <span class="at">log =</span> T)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(ll)</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    log_joint <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(ll_base)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(log_joint)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="co">#' fit has intercept, prior_variance, mu, tau, ll0</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>gauss_hermite2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, o, ll0, fit, <span class="at">m=</span><span class="dv">9</span>){</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">with</span>(fit, <span class="fu">make_log_joint</span>(x, y, o, intercept, prior_variance))</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">gauss_hermite</span>(f, fit<span class="sc">$</span>mu, fit<span class="sc">$</span>tau, ll0, <span class="at">m =</span> m))</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="code-for-experiments" class="level3">
<h3 class="anchored" data-anchor-id="code-for-experiments">Code for experiments</h3>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-6_0a1cac99fba187a146b733c22f243c84">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>mle_fixed_intercept <span class="ot">&lt;-</span> <span class="cf">function</span> (x, y, o, b0, ll0, <span class="at">family =</span> <span class="st">"binomial"</span>) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x <span class="sc">+</span> <span class="dv">0</span>, <span class="at">offset =</span> (o<span class="sc">+</span>b0), <span class="at">family=</span>family)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">#fastglm::fastglm(y = y, x = as.matrix(x, ncol=1), offset = o + b0, family = family)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    coef <span class="ot">&lt;-</span> <span class="fu">unname</span>(fit<span class="sc">$</span>coefficients)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    intercept <span class="ot">&lt;-</span> b0</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    betahat <span class="ot">&lt;-</span> coef[<span class="dv">1</span>]</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    shat2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit)<span class="sc">$</span>coef[<span class="dv">1</span>, <span class="dv">2</span>]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    ll <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> fit<span class="sc">$</span>deviance</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    lr <span class="ot">&lt;-</span> ll <span class="sc">-</span> ll0</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">betahat =</span> betahat, <span class="at">shat2 =</span> shat2, <span class="at">intercept =</span> intercept, </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">lr =</span> lr, <span class="at">ll0 =</span> ll0, <span class="at">ll =</span> ll)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(res)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>driver <span class="ot">&lt;-</span> <span class="cf">function</span>(sim, prior_variance, <span class="at">max_m=</span><span class="dv">32</span>){</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  o <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(sim<span class="sc">$</span>y))</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  adaptive <span class="ot">&lt;-</span> <span class="fu">with</span>(sim, logisticsusie<span class="sc">::</span><span class="fu">logistic_bayes</span>(x, y, o, prior_variance))</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  mle <span class="ot">&lt;-</span> <span class="fu">with</span>(sim, <span class="fu">laplace_mle</span>(</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mle_fixed_intercept</span>(x, y, o, adaptive<span class="sc">$</span>intercept, ll0), <span class="at">prior_variance=</span>prior_variance))</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  map <span class="ot">&lt;-</span> <span class="fu">with</span>(sim, logisticsusie<span class="sc">:::</span><span class="fu">ridge</span>(x, y, o, <span class="at">prior_variance=</span>prior_variance))</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  jj <span class="ot">&lt;-</span> <span class="fu">with</span>(sim, logisticsusie<span class="sc">::</span><span class="fu">fit_univariate_vb</span>(x, y, o, <span class="at">tau0=</span><span class="dv">1</span><span class="sc">/</span>prior_variance))</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  jj<span class="sc">$</span>logZ <span class="ot">&lt;-</span> <span class="fu">tail</span>(jj<span class="sc">$</span>elbo, <span class="dv">1</span>)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  gh_map <span class="ot">&lt;-</span> <span class="fu">with</span>(sim, purrr<span class="sc">::</span><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>max_m, <span class="sc">~</span><span class="fu">gauss_hermite2</span>(x, y, o, ll0, map, <span class="at">m=</span>.x)))</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  gh_mle <span class="ot">&lt;-</span> <span class="fu">with</span>(sim, purrr<span class="sc">::</span><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>max_m, <span class="sc">~</span><span class="fu">gauss_hermite2</span>(x, y, o, ll0, mle, <span class="at">m=</span>.x)))</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  prior <span class="ot">&lt;-</span> <span class="fu">with</span>(map, <span class="fu">list</span>(<span class="at">intercept=</span>intercept, <span class="at">ll0=</span>ll0, <span class="at">mu=</span><span class="dv">0</span>, <span class="at">prior_variance=</span>prior_variance, <span class="at">tau0 =</span> <span class="dv">1</span><span class="sc">/</span>prior_variance, <span class="at">tau=</span><span class="dv">1</span><span class="sc">/</span>prior_variance))</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  gh_prior <span class="ot">&lt;-</span> <span class="fu">with</span>(sim, purrr<span class="sc">::</span><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>max_m, <span class="sc">~</span><span class="fu">gauss_hermite2</span>(x, y, o, ll0, prior, <span class="at">m=</span>.x)))</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">adaptive=</span>adaptive, <span class="at">mle=</span>mle, <span class="at">map=</span>map, <span class="at">jj =</span> jj, <span class="at">gh_map=</span>gh_map, <span class="at">gh_mle=</span>gh_mle, <span class="at">gh_prior=</span>gh_prior, <span class="at">prior=</span>prior))</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>make_plot<span class="ot">&lt;-</span> <span class="cf">function</span>(fits, <span class="at">ylim=</span><span class="cn">NULL</span>, <span class="at">val=</span><span class="st">'logZ'</span>){</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># unpack</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  gh_map <span class="ot">&lt;-</span> fits<span class="sc">$</span>gh_map</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>  gh_mle <span class="ot">&lt;-</span> fits<span class="sc">$</span>gh_mle</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  gh_prior <span class="ot">&lt;-</span> fits<span class="sc">$</span>gh_prior</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>  adaptive <span class="ot">&lt;-</span> fits<span class="sc">$</span>adaptive</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>  mle <span class="ot">&lt;-</span> fits<span class="sc">$</span>mle</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>  map <span class="ot">&lt;-</span> fits<span class="sc">$</span>map</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>  jj <span class="ot">&lt;-</span> fits<span class="sc">$</span>jj</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(val <span class="sc">==</span> <span class="st">'logZ'</span>){</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    gh_map_vals <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(gh_map, <span class="sc">~</span>.x<span class="sc">$</span>logZ)</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    gh_mle_vals <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(gh_mle, <span class="sc">~</span>.x<span class="sc">$</span>logZ)</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    gh_prior_vals <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(gh_prior, <span class="sc">~</span>.x<span class="sc">$</span>logZ)</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>    adaptive_val <span class="ot">&lt;-</span> adaptive<span class="sc">$</span>logZ</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>    map_val <span class="ot">&lt;-</span> map<span class="sc">$</span>logZ</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>    mle_val <span class="ot">&lt;-</span> mle<span class="sc">$</span>logZ</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>    jj_val <span class="ot">&lt;-</span> jj<span class="sc">$</span>logZ</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>  max_m <span class="ot">&lt;-</span> <span class="fu">length</span>(gh_map_vals)</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(ylim)){</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    ylim <span class="ot">&lt;-</span> <span class="fu">range</span>(gh_map_vals, gh_mle_vals, gh_prior_vals, adaptive_val, mle_val)</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span>max_m, <span class="fu">rep</span>(adaptive_val, max_m), <span class="at">col=</span><span class="st">'black'</span>, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">ylim=</span>ylim, <span class="at">lwd=</span><span class="dv">2</span>,</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>         <span class="at">xlab =</span> <span class="st">'Quadrature points'</span>, <span class="at">ylab=</span><span class="st">'Posterior variance'</span>)</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="dv">1</span><span class="sc">:</span>max_m, <span class="fu">rep</span>(map_val, max_m), <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="dv">1</span><span class="sc">:</span>max_m, <span class="fu">rep</span>(mle_val, max_m), <span class="at">col=</span><span class="st">'blue'</span>)</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="dv">1</span><span class="sc">:</span>max_m, <span class="fu">rep</span>(jj_val, max_m), <span class="at">col=</span><span class="st">'purple'</span>)</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(<span class="dv">1</span><span class="sc">:</span>max_m, gh_map_vals, <span class="at">col=</span><span class="st">'red'</span>, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(<span class="dv">1</span><span class="sc">:</span>max_m, gh_mle_vals, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">pch=</span><span class="dv">3</span>)</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(<span class="dv">1</span><span class="sc">:</span>max_m, gh_prior_vals, <span class="at">col=</span><span class="st">'green'</span>, <span class="at">pch=</span><span class="dv">1</span>)</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>make_legend <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="cn">NULL</span> ,<span class="at">xaxt=</span><span class="st">'n'</span>,<span class="at">yaxt=</span><span class="st">'n'</span>,<span class="at">bty=</span><span class="st">'n'</span>,<span class="at">ylab=</span><span class="st">''</span>,<span class="at">xlab=</span><span class="st">''</span>, <span class="at">xlim=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">ylim=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">'topleft'</span>,</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>         <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'GH (MAP)'</span>,</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'GH (MLE)'</span>, </span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'GH (Prior)'</span>),</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>         <span class="at">col=</span><span class="fu">c</span>(<span class="st">'red'</span>, <span class="st">'blue'</span>, <span class="st">'green'</span>),</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>         <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">16</span>, <span class="dv">3</span>, <span class="dv">1</span>))</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">'bottomleft'</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'Adaptive'</span>, <span class="st">'Laplace (MAP)'</span>, <span class="st">'Laplace (MLE)'</span>, <span class="st">'JJ'</span>),</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>         <span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>, <span class="st">'red'</span>, <span class="st">'blue'</span>, <span class="st">'purple'</span>), <span class="at">lty=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="experiments" class="level2">
<h2 class="anchored" data-anchor-id="experiments">Experiments</h2>
<p>Output: a plot that shows accuracy of a posterior summary for</p>
<ul class="task-list">
<li><input type="checkbox" disabled="">Adaptive quadrature</li>
<li><input type="checkbox" disabled="">Laplace approximation</li>
<li><input type="checkbox" disabled="">Gauss-Hermite quadrature (MAP) (at range of quadrature points)</li>
<li><input type="checkbox" disabled="">Gauss-Hermite quadrature (MLE) (at range of quadrature points)</li>
<li><input type="checkbox" disabled="">Gauss-Hermite quadrature (Prior) (at range of quadrature points)</li>
<li><input type="checkbox" disabled="">Gauss-Hermite quadrature (other expansion point) (at range of quadrature points)</li>
</ul>
<p>We plot the number of quadrature points against the approximate the the log-marginal likelihood. For Laplace-MAP, Laplace-MLE, Jaakkola-Jordan, and adaptive quadrature we plot the log-marginal likelihood as a horizontal line.</p>
<p>The left panel shows the log-marginal likelihood on a scale where all results are visible, this gives us a birds eye view of the accuracy of our method and helps us characterize in what scenarios method(s) fail. On the write panel we zoom in to <span class="math inline">\(\log p(y | x) \pm 0.5\)</span> to show accuracy on a finer scale.</p>
<section id="completely-enriched" class="level3">
<h3 class="anchored" data-anchor-id="completely-enriched">Completely enriched</h3>
<p>In the completely enriched case the MLE does not exist and we get degenerate estimates from software for computing the MLE. The exceedingly large standard error means that Laplace-MLE essentially gives the prior.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-7_bd8d17d3de457bbb14b2ebece120da5a">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">sim1</span>()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>fits <span class="ot">&lt;-</span> <span class="fu">driver</span>(sim, <span class="fl">1.</span>, <span class="dv">16</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(fits)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(fits, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span>) <span class="sc">+</span> fits<span class="sc">$</span>adaptive<span class="sc">$</span>logZ)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">make_legend</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="seperable-binary-covariate" class="level3">
<h3 class="anchored" data-anchor-id="seperable-binary-covariate">Seperable, binary covariate</h3>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-8_a6f4a37b67d2fa46db61136c09d4aaec">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">sim2</span>()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>fits <span class="ot">&lt;-</span> <span class="fu">driver</span>(sim, <span class="fl">1.</span>, <span class="dv">16</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(fits)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(fits, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span>) <span class="sc">+</span> fits<span class="sc">$</span>adaptive<span class="sc">$</span>logZ)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="fu">make_legend</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="seperable-continuous-covariate" class="level3">
<h3 class="anchored" data-anchor-id="seperable-continuous-covariate">Seperable, continuous covariate</h3>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-9_3b87b0f3392bc4adf50c90127e27dfba">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">sim3</span>()</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>fits <span class="ot">&lt;-</span> <span class="fu">driver</span>(sim, <span class="fl">1.</span>, <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(fits)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(fits, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span>) <span class="sc">+</span> fits<span class="sc">$</span>adaptive<span class="sc">$</span>logZ)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">make_legend</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="regular-binary-covariate" class="level3">
<h3 class="anchored" data-anchor-id="regular-binary-covariate">Regular, binary covariate</h3>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-10_898214bc6735a2826563aa7329845fa7">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">sim4</span>()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>fits <span class="ot">&lt;-</span> <span class="fu">driver</span>(sim, <span class="fl">1.</span>, <span class="dv">16</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(fits)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(fits, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span>) <span class="sc">+</span> fits<span class="sc">$</span>adaptive<span class="sc">$</span>logZ)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="fu">make_legend</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="regular-continuous-covariate" class="level3">
<h3 class="anchored" data-anchor-id="regular-continuous-covariate">Regular, continuous covariate</h3>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-11_38f9adfcb40cbee8e12e74bd289d62dd">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">sim5</span>()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>fits <span class="ot">&lt;-</span> <span class="fu">driver</span>(sim, <span class="fl">1.</span>, <span class="dv">16</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(fits)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(fits, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span>) <span class="sc">+</span> fits<span class="sc">$</span>adaptive<span class="sc">$</span>logZ)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="fu">make_legend</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="c1-gs66-example" class="level3">
<h3 class="anchored" data-anchor-id="c1-gs66-example">C1-GS66 example</h3>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-12_813fef56077aa458bd1a98a514fd1f9a">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">sim6</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>loading gene set from msigdbr: C1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `geneSet`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>fits <span class="ot">&lt;-</span> <span class="fu">driver</span>(sim, <span class="fl">1.</span>, <span class="dv">16</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(fits)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(fits, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span>) <span class="sc">+</span> fits<span class="sc">$</span>adaptive<span class="sc">$</span>logZ)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">make_legend</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="old" class="level2">
<h2 class="anchored" data-anchor-id="old">OLD</h2>
<section id="gauss-hermite-quadrature-1" class="level3">
<h3 class="anchored" data-anchor-id="gauss-hermite-quadrature-1">Gauss-Hermite Quadrature</h3>
<p>Gauss-Hermite quadrature is a natural choice for integrating over normal priors. We need to make a choice about where to “center” the prior</p>
</section>
<section id="gauss-hermite-at-the-map" class="level3">
<h3 class="anchored" data-anchor-id="gauss-hermite-at-the-map">Gauss Hermite at the MAP</h3>
<p>In this simulation the Laplace approximation is extremely accurate, and it only take 4 quadrature points to get a Gauss-Hermite quadrature rule that matches adaptive quadrature.</p>
</section>
<section id="gauss-hermite-approximate-map" class="level3">
<h3 class="anchored" data-anchor-id="gauss-hermite-approximate-map">Gauss-Hermite, approximate MAP</h3>
<section id="map-mle" class="level4">
<h4 class="anchored" data-anchor-id="map-mle">MAP-MLE</h4>
<p>Here we first compute the MLE, and then approximate the MAP by taking a quadratic approximation of the likelihood and combining it with the prior. This approximation also gives us an approximation of the log-marginal likelihood (green), however this approximation must be distinguished from the true MAP approximation (blue), as well as the approximation yielded by expanding at the approximate MAP computed (<span class="math inline">\(m=1\)</span>).</p>
<p>We see that the MLE-based MAP approximation is not very good. But the situation quickly improves even for the one-point Gauss-Hermite quadrature. The one point quadrature and Laplace approximation correspond when the single evaluation point is the mode, and the Gauss-Hermite quadrature rule is appropriately transformed to reflect the curvature at this point <span class="citation" data-cites="liuNoteGaussHermite1994">(<a href="#ref-liuNoteGaussHermite1994" role="doc-biblioref">LIU and PIERCE 1994</a>)</span>. However, this does not hold at the approximate MAP. First, the approximation of the likelihood at the approximate MAP is only an approximation. Second, the <span class="math inline">\(1\)</span>-point Gauss-Hermite quadrature does not quite correspond to the expansion at the approximate MAP, as the first order term in the approximation is assumed to be zero. For that to be true we must either be at the mode (so the gradient is 0) or the mean (so the expected value of the first order term is 0)$.</p>
</section>
<section id="map-map" class="level4">
<h4 class="anchored" data-anchor-id="map-map">MAP-MAP</h4>
<p>Here we compute the MAP at some other value of the prior variance. We then “unshrink” the fit, and then “reshrink” it at the prior variance of interest.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-13_217351497f28c956640c6d515ceeaa77">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>fit10 <span class="ot">&lt;-</span> logisticsusie<span class="sc">:::</span><span class="fu">ridge</span>(x, y, o, <span class="at">prior_variance=</span><span class="dv">10</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>fit10_1 <span class="ot">&lt;-</span> <span class="fu">laplace_map</span>(fit10, <span class="at">prior_variance=</span><span class="dv">1</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>fit10_1<span class="sc">$</span>logZ</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="fu">gauss_hermite2</span>(x, y, o, fit10_1, <span class="at">m=</span><span class="dv">1</span>)<span class="sc">$</span>logZ <span class="co"># should agree with laplace</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>gh <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">32</span>, <span class="sc">~</span><span class="fu">gauss_hermite2</span>(x, y, o, fit10_1, <span class="at">m=</span>.x)<span class="sc">$</span>logZ)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">32</span>, gh[<span class="dv">1</span><span class="sc">:</span><span class="dv">32</span>], <span class="at">ylim=</span><span class="fu">range</span>(gh, fit10_1<span class="sc">$</span>logZ, fit1<span class="sc">$</span>logZ, quad<span class="sc">$</span>logZ));</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> quad<span class="sc">$</span>logZ, <span class="at">col=</span><span class="st">'red'</span>);</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> fit1<span class="sc">$</span>logZ, <span class="at">col=</span><span class="st">'blue'</span>);</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> fit10_1<span class="sc">$</span>logZ, <span class="at">col=</span><span class="st">'green'</span>);</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">32</span>, gh[<span class="dv">1</span><span class="sc">:</span><span class="dv">32</span>], <span class="at">ylim=</span><span class="fu">range</span>(gh, fit1<span class="sc">$</span>logZ, quad<span class="sc">$</span>logZ));</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> quad<span class="sc">$</span>logZ, <span class="at">col=</span><span class="st">'red'</span>);</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> fit1<span class="sc">$</span>logZ, <span class="at">col=</span><span class="st">'blue'</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The “unshrink” then “reshrink” procedure is probably better when we want to shrink more aggressively, but can be unreliable when we want to shrink less aggressively. In the extreme, we set the prior variance to a very small value. The MLE is way out in the tail of this Laplace approximation and our reconstruction can be very poor. Here we see even as we increase the number of quadrature points, the approximation fails to converge to the true value.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-14_6c89a46f20ea7791293d3d6a998e10b5">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fit1em5 <span class="ot">&lt;-</span> logisticsusie<span class="sc">:::</span><span class="fu">ridge</span>(x, y, o, <span class="at">prior_variance=</span><span class="fl">1e-10</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>fit1em5_1 <span class="ot">&lt;-</span> <span class="fu">laplace_map</span>(fit1em5, <span class="at">prior_variance=</span><span class="dv">1</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>fit1em5_1<span class="sc">$</span>logZ</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">gauss_hermite2</span>(x, y, o, fit1em5_1, <span class="at">m=</span><span class="dv">1</span>)<span class="sc">$</span>logZ <span class="co"># should agree with laplace</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>gh <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">32</span>, <span class="sc">~</span><span class="fu">gauss_hermite2</span>(x, y, o, fit1em5_1, <span class="at">m=</span>.x)<span class="sc">$</span>logZ)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">32</span>, gh[<span class="dv">1</span><span class="sc">:</span><span class="dv">32</span>], <span class="at">ylim=</span><span class="fu">range</span>(gh, fit1em5<span class="sc">$</span>logZ, fit1<span class="sc">$</span>logZ, quad<span class="sc">$</span>logZ));</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> quad<span class="sc">$</span>logZ, <span class="at">col=</span><span class="st">'red'</span>);</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> fit1<span class="sc">$</span>logZ, <span class="at">col=</span><span class="st">'blue'</span>);</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> fit1em5<span class="sc">$</span>logZ, <span class="at">col=</span><span class="st">'green'</span>);</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">32</span>, gh[<span class="dv">1</span><span class="sc">:</span><span class="dv">32</span>], <span class="at">ylim=</span><span class="fu">range</span>(gh, fit1<span class="sc">$</span>logZ, quad<span class="sc">$</span>logZ));</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> quad<span class="sc">$</span>logZ, <span class="at">col=</span><span class="st">'red'</span>);</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> fit1<span class="sc">$</span>logZ, <span class="at">col=</span><span class="st">'blue'</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="gauss-hermite-at-the-prior" class="level3">
<h3 class="anchored" data-anchor-id="gauss-hermite-at-the-prior">Gauss-Hermite at the prior</h3>
<p>Here we explore Gauss-Hermite quadrature over the prior <span class="math inline">\(q = N(0, \sigma^2_0)\)</span>. We see that (1) it takes a large number of quadrature points to get a good approximation of the log-marginal likelihood. and (2) the approximation error oscillates.</p>
<p>Note that we fix the intercept at the MAP estimate of the intercept, so that we can expect as the quadrature points increase, the marginal likelihood should converge to the same result as adaptive quadrature and Gauss-Hermite at the MAP.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-15_bbcda06ef5cb631c4de45681e81564ab">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>null_intercept <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">mean</span>(y)<span class="sc">/</span><span class="fu">mean</span>(<span class="dv">1</span><span class="sc">-</span>y))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>ll <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">dbinom</span>(y, <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>quad<span class="sc">$</span>intercept)), <span class="at">log=</span>T))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>null <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">prior_variance=</span><span class="dv">1</span>, <span class="at">tau0 =</span> <span class="dv">1</span>, <span class="at">intercept =</span> quad<span class="sc">$</span>intercept, <span class="at">ll=</span>ll, <span class="at">ll0 =</span> ll0)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>gh_null <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dbl</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">128</span>, <span class="sc">~</span><span class="fu">gauss_hermite2</span>(x, y, o, null, <span class="at">m=</span>.x)<span class="sc">$</span>logZ)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">128</span>, gh_null[<span class="dv">1</span><span class="sc">:</span><span class="dv">128</span>]); <span class="fu">abline</span>(<span class="at">h =</span> quad<span class="sc">$</span>logZ, <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">10</span><span class="sc">:</span><span class="dv">128</span>, gh_null[<span class="dv">10</span><span class="sc">:</span><span class="dv">128</span>]); <span class="fu">abline</span>(<span class="at">h =</span> quad<span class="sc">$</span>logZ, <span class="at">col=</span><span class="st">'red'</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">100</span><span class="sc">:</span><span class="dv">128</span>, gh_null[<span class="dv">100</span><span class="sc">:</span><span class="dv">128</span>]); <span class="fu">abline</span>(<span class="at">h =</span> quad<span class="sc">$</span>logZ, <span class="at">col=</span><span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="dealing-with-the-intercept" class="level2">
<h2 class="anchored" data-anchor-id="dealing-with-the-intercept">Dealing with the intercept</h2>
<section id="fixed-intercept" class="level3">
<h3 class="anchored" data-anchor-id="fixed-intercept">Fixed intercept</h3>
<p>In the above demonstration we have worked with a fixed intercept.</p>
<p>Notably, we still got very similar results for the MAP-MAP and MAP-MLE approaches, which used the intercept from the MAP under a <em>different setting of the prior variance</em> or the intercept from the MLE.</p>
</section>
<section id="profile-likelihood" class="level3">
<h3 class="anchored" data-anchor-id="profile-likelihood">Profile likelihood</h3>
<p>One option is a profile likelihood approach. The idea is that we replace the likelihood <span class="math inline">\(f(\beta,\beta_0)=\log p(y | \beta, \beta_0)\)</span> with <span class="math inline">\(g(\beta) = \max_{\beta_0} f(\beta, \beta_0)\)</span>. For example, under the null model (<span class="math inline">\(\beta = 0\)</span>) when there is no offset, we can easily compute the setting of the intercept that maximize <span class="math inline">\(\arg\max_{\beta_0}f(0, \beta_0) - \log \frac{\bar y}{1 - \bar y}\)</span>. I wonder if there is an analytic solution for the intercept when the offset/effects are non-zero. In this case we could cheaply update the intercept before marginalizing over <span class="math inline">\(\beta\)</span>.</p>
<p>Otherwise, it will take a few Newton steps (e.g.&nbsp;5) to maximize the intercept, in which case we may be better off using those likelihood evaluations to integrate over the prior using a quadrature rule.</p>
</section>
<section id="integrating-over-the-intercept" class="level3">
<h3 class="anchored" data-anchor-id="integrating-over-the-intercept">Integrating over the intercept</h3>
<p>We consider integrating the intercept over a flat prior. For a given value of the effect, we would marginalize over the intercept with a Gauss-Hermite quadrature or a Laplace approximation. Here we provide code for computing the marginal likelihood where we integrate over the effect and intercept when there is a normal prior on the intercept. We set the prior variance to a large value, <span class="math inline">\(\sigma^2_{int} = 1000\)</span>, so that it is effectively a flat prior.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-16_053532a3d51b71ef8cd9eb0d646aaa15">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>integrate_intercept <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, o, <span class="at">prior_variance=</span><span class="dv">1</span>, <span class="at">m_int=</span><span class="dv">5</span>, <span class="at">m=</span><span class="dv">5</span>){</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. fit MAP</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  tau0 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>prior_variance</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  ridgefit <span class="ot">&lt;-</span> logisticsusie<span class="sc">:::</span><span class="fu">ridge</span>(x, y, o, <span class="at">prior_variance=</span><span class="dv">1</span><span class="sc">/</span>tau0)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. make function that marginalized over the intercept (flat prior)</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  intercept_marginalized <span class="ot">&lt;-</span> <span class="cf">function</span>(b){</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># log p(y, b | b0)</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    f1 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(b0){</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>      psi <span class="ot">&lt;-</span> b0 <span class="sc">+</span> x <span class="sc">*</span> b</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(o)) {</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>          psi <span class="ot">&lt;-</span> psi <span class="sc">+</span> o</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">sum</span>((y <span class="sc">*</span> psi) <span class="sc">-</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(psi))) <span class="sc">+</span> <span class="fu">dnorm</span>(b, <span class="dv">0</span>, </span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>tau0), <span class="at">log =</span> T) <span class="sc">+</span> <span class="fu">dnorm</span>(b0, <span class="dv">0</span>, <span class="at">sd=</span><span class="dv">10000</span>, <span class="at">log=</span>T))</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># adaptive quadrature</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(m_int <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span>){</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>      <span class="co"># log p(y, b | b0) - logp(y, b_MAP | b0_MAP)</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>      C <span class="ot">&lt;-</span> <span class="fu">f1</span>(ridgefit<span class="sc">$</span>intercept)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>      f2 <span class="ot">&lt;-</span> <span class="fu">Shift</span>(f1, C)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>      I <span class="ot">&lt;-</span> <span class="fu">integrate</span>(<span class="fu">Exp</span>(f2), <span class="sc">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>)</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>      logZ <span class="ot">&lt;-</span> <span class="fu">log</span>(I<span class="sc">$</span>value) <span class="sc">+</span> C</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>      <span class="co"># gauss-hermite, center at MAP</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>      b0 <span class="ot">&lt;-</span> ridgefit<span class="sc">$</span>intercept</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>      psi <span class="ot">&lt;-</span> b0 <span class="sc">+</span> x <span class="sc">*</span> b <span class="sc">+</span> o</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>      mu <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>psi))</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>      tau <span class="ot">&lt;-</span> <span class="fu">sum</span>(mu <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> mu))</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>      <span class="co"># function logq(b)</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>      logq <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">dnorm</span>(x, <span class="at">mean=</span>b0, <span class="at">sd=</span><span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>tau), <span class="at">log=</span>T) </span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>      h <span class="ot">&lt;-</span> <span class="fu">Diff</span>(f1, logq)</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>      quad_points <span class="ot">&lt;-</span> statmod<span class="sc">::</span><span class="fu">gauss.quad.prob</span>(m_int, <span class="at">dist=</span><span class="st">'normal'</span>, <span class="at">mu=</span>b0, <span class="at">sigma=</span><span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>tau))</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>      logZ <span class="ot">&lt;-</span> <span class="fu">logsumexp</span>(<span class="fu">h</span>(quad_points<span class="sc">$</span>nodes) <span class="sc">+</span> <span class="fu">log</span>(quad_points<span class="sc">$</span>weights))</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>      logZ</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(logZ)</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. compute marginal likelihood</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>  C <span class="ot">&lt;-</span> <span class="fu">intercept_marginalized</span>(ridgefit<span class="sc">$</span>mu)</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>  f2 <span class="ot">&lt;-</span> <span class="fu">Shift</span>(intercept_marginalized, C)</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># function logq(b)</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>  logq <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dnorm</span>(x, <span class="at">mean=</span>ridgefit<span class="sc">$</span>mu, <span class="at">sd=</span><span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>ridgefit<span class="sc">$</span>tau), <span class="at">log=</span>T) </span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>  h <span class="ot">&lt;-</span> <span class="fu">Diff</span>(intercept_marginalized, logq)</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>  quad_points <span class="ot">&lt;-</span> statmod<span class="sc">::</span><span class="fu">gauss.quad.prob</span>(m, <span class="at">dist=</span><span class="st">'normal'</span>, <span class="at">mu=</span>ridgefit<span class="sc">$</span>mu, <span class="at">sigma=</span><span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>ridgefit<span class="sc">$</span>tau))</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>  logZ <span class="ot">&lt;-</span> <span class="fu">logsumexp</span>(<span class="fu">h</span>(quad_points<span class="sc">$</span>nodes) <span class="sc">+</span> <span class="fu">log</span>(quad_points<span class="sc">$</span>weights))</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(logZ)</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see close agreement between the 1 x 1 and 64 x 64 Gauss-Hermite quadrature rules. This suggests that we can effectively integrate over both the intercept and the prior with just a few likelihood evaluations.</p>
<p>Note that when we use the Laplace approximation (or <span class="math inline">\(1\)</span>-point Gauss-Hermite quadrature) we effectively scale the fixed-intercept BFs by <span class="math inline">\(\sqrt{\frac{2\pi}{\tau_{int}}}\)</span>. where <span class="math inline">\(\tau_{int} = \frac{d^2}{d\beta_0^2} \log p(y, \hat \beta, \beta_0 | x) \vert_{\beta_0 = \hat \beta_0}\)</span>.</p>
<p>Consider this nested 1d quadrature scheme. In the <span class="math inline">\(1 \times 1\)</span> case it seems to correspond to a “diagonalized” Laplace approximation. In particular it does not take into account the dependence between the intercept and effect.</p>
<p>Perhaps the correct thing to do is a multivariate Gauss-Hermite quadrature <span class="citation" data-cites="jackelNoteMultivariateGaussHermite">(<a href="#ref-jackelNoteMultivariateGaussHermite" role="doc-biblioref">Jäckel, n.d.</a>)</span>. This is an obvious extension to the 1d Gauss-Hermite quadrature rule, and it would allow us to more accurately deal with the dependence between the intercept and effect estimates. As discuessed in the reference, different decompositions of the covariance matrix will yield different quadrature rules.But basically, you should think of taking the isotropic 2d quadrature rule and rotating + stretching it to align it with a local model of the curvature at the mode.</p>
<p>It’s worth noting that the cost of computing a decomposition of a <span class="math inline">\(2 \times 2\)</span> matrix is negligible compared to the cost of evaluating the likelihood at a single point. It probably makes sense to invest in taking this step because it allows us to better invest our our evaluation points.</p>
<p>It is satisfying also, that we restore our relationship between the (multivariate) Gauss-Hermite and the (multivariate) Laplace approximation in the <span class="math inline">\(1\)</span>-point quadrature rule (TODO: confirm this!).</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-17_bc4e2db42ca7db5ea3415d53b721bd5a">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(sim, {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">integrate_intercept</span>(x, y, o, <span class="dv">1</span>, <span class="at">m_int=</span><span class="dv">1</span>, <span class="at">m=</span><span class="dv">1</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">integrate_intercept</span>(x, y, o, <span class="dv">1</span>, <span class="at">m_int=</span><span class="sc">-</span><span class="dv">1</span>, <span class="at">m=</span><span class="dv">1</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">integrate_intercept</span>(x, y, o, <span class="dv">1</span>, <span class="at">m_int=</span><span class="dv">1</span>, <span class="at">m=</span><span class="dv">64</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">integrate_intercept</span>(x, y, o, <span class="dv">1</span>, <span class="at">m_int=</span><span class="sc">-</span><span class="dv">1</span>, <span class="at">m=</span><span class="dv">64</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">integrate_intercept</span>(x, y, o, <span class="dv">1</span>, <span class="at">m_int=</span><span class="dv">3</span>, <span class="at">m=</span><span class="dv">3</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">integrate_intercept</span>(x, y, o, <span class="dv">1</span>, <span class="at">m_int=</span><span class="dv">5</span>, <span class="at">m=</span><span class="dv">5</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">integrate_intercept</span>(x, y, o, <span class="dv">1</span>, <span class="at">m_int=</span><span class="dv">1</span>, <span class="at">m=</span><span class="dv">5</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">integrate_intercept</span>(x, y, o, <span class="dv">1</span>, <span class="at">m_int=</span><span class="dv">1</span>, <span class="at">m=</span><span class="dv">5</span>)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">integrate_intercept</span>(x, y, o, <span class="dv">1</span>, <span class="at">m_int=</span><span class="dv">64</span>, <span class="at">m=</span><span class="dv">64</span>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">integrate_intercept</span>(x, y, o, <span class="dv">1</span>, <span class="at">m_int=</span><span class="dv">128</span>, <span class="at">m=</span><span class="dv">128</span>)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -1672.67</code></pre>
</div>
</div>
</section>
<section id="multivariate-gauss-hermite" class="level3">
<h3 class="anchored" data-anchor-id="multivariate-gauss-hermite">Multivariate Gauss-Hermite</h3>
<p><span class="math inline">\(\Sigma = LL^T\)</span> is a covariance matrix and it’s corresponding Cholesky decomposition. So that if <span class="math inline">\({\bf z} \sim N(0, I)\)</span> then <span class="math inline">\(L {\bf z} + \mu \sim N(\mu, \Sigma)\)</span>. With <span class="math inline">\({\bf b}({\bf z}) = L {\bf z} + \mu\)</span></p>
<p><span class="math display">\[\begin{align}
p(y)
&amp;= \int_{\mathbb R^2} \frac{p(y, {\bf b})}{q({\bf b})} q({\bf b}) d{\bf b} \\
&amp;= \int_{\mathbb R^2} \frac{p(y, {\bf b})}{\exp\{-\frac{1}{2} ({\bf b} - \mu)^T \Sigma^{-1} ({\bf b}-\mu) \}} \exp\{-\frac{1}{2} ({\bf b} - \mu)^T \Sigma^{-1} ({\bf b}-\mu) \} d{\bf b} \\
&amp;= \det L \int_{\mathbb R^2} \frac{p(y, {\bf b}({\bf z}))}{\exp\{-\frac{1}{2} {\bf z}^T {\bf z} \}} \exp\{-\frac{1}{2} {\bf z}^T {\bf z} \} d{\bf z}
\end{align}\]</span></p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-18_f5415a68823278377dce47e22a82b994">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1000</span>, <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>x)))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>o <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(y))</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>ll0 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">dbinom</span>(y, <span class="dv">1</span>, <span class="fu">mean</span>(y), <span class="at">log=</span>T))</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>prior_variance <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> logisticsusie<span class="sc">:::</span><span class="fu">ridge</span>(x, y, o, <span class="at">prior_variance=</span><span class="dv">1</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>X0 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(x)), x)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>psi <span class="ot">&lt;-</span> map<span class="sc">$</span>intercept <span class="sc">+</span> x <span class="sc">*</span> map<span class="sc">$</span>mu <span class="sc">+</span> o</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>psi)) </span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">t</span>(X0) <span class="sc">%*%</span> (y <span class="sc">-</span> mu) <span class="sc">+</span> <span class="fu">c</span>(<span class="dv">0</span>, map<span class="sc">$</span>mu<span class="sc">/</span>prior_variance)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>H <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">t</span>(X0) <span class="sc">%*%</span> (mu <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> mu) <span class="sc">*</span> X0) <span class="sc">-</span> <span class="fu">diag</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>prior_variance))</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior precision is -H</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co"># LL^T = Sigma = -H^{-1}</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">chol</span>(<span class="sc">-</span>H))</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, map<span class="sc">$</span>mu)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>f1 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(b0, b1){</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  psi <span class="ot">&lt;-</span> b0 <span class="sc">+</span> x <span class="sc">*</span> b1 <span class="sc">+</span> o</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sum</span>((y <span class="sc">*</span> psi) <span class="sc">-</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(psi))) <span class="sc">+</span> <span class="fu">dnorm</span>(b1, <span class="dv">0</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(prior_variance), <span class="at">log =</span> T) <span class="sc">+</span> <span class="fu">dnorm</span>(b0, <span class="dv">0</span>, <span class="at">sd=</span><span class="dv">10000</span>, <span class="at">log=</span>T))</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>f2 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(z1, z2){</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">&lt;-</span> <span class="fu">c</span>(z1, z2)</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="dv">2</span>) <span class="sc">*</span> (L<span class="sc">%*%</span>z)[,<span class="dv">1</span>] <span class="sc">+</span> mu</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">f1</span>(beta[<span class="dv">1</span>], beta[<span class="dv">2</span>]) <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">sum</span>(z<span class="sc">*</span>z)</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>C <span class="ot">&lt;-</span> <span class="fu">f1</span>(map<span class="sc">$</span>intercept, map<span class="sc">$</span>mu)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="dv">9</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>quad_points <span class="ot">&lt;-</span> statmod<span class="sc">::</span><span class="fu">gauss.quad.prob</span>(m, <span class="at">dist=</span><span class="st">'normal'</span>, <span class="at">mu=</span><span class="dv">0</span>, <span class="at">sigma=</span><span class="dv">1</span>)</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>quad_points <span class="ot">&lt;-</span> statmod<span class="sc">::</span><span class="fu">gauss.quad</span>(m, <span class="at">kind=</span><span class="st">'hermite'</span>)</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>z1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(quad_points<span class="sc">$</span>nodes, m)</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>z2 <span class="ot">&lt;-</span> <span class="fu">rep</span>(quad_points<span class="sc">$</span>nodes, <span class="at">each=</span>m)</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">cbind</span>(z1, z2)</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">rep</span>(quad_points<span class="sc">$</span>weights, m) <span class="sc">*</span> <span class="fu">rep</span>(quad_points<span class="sc">$</span>weights, <span class="at">each=</span>m)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>logZ <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">log</span>(<span class="fu">diag</span>(L))) <span class="sc">+</span> <span class="fu">logsumexp</span>(<span class="fu">f2</span>(z1, z2) <span class="sc">+</span> <span class="fu">log</span>(w))</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>logZ</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -586.4751</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">integrate_intercept</span>(x, y, o, <span class="dv">1</span>, <span class="at">m_int=</span><span class="dv">9</span>, <span class="at">m=</span><span class="dv">9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -585.3545</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>mle <span class="ot">&lt;-</span> logisticsusie<span class="sc">:::</span><span class="fu">fit_fast_glm</span>(x, y, <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(y)), ll0)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># -H^{-1} = Q %*% t(Q)</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>Q <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">with</span>(<span class="fu">svd</span>(<span class="sc">-</span>H), <span class="fu">diag</span>(<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(d)) <span class="sc">%*%</span> <span class="fu">t</span>(v)))</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>quad_points <span class="ot">&lt;-</span> statmod<span class="sc">::</span><span class="fu">gauss.quad.prob</span>(<span class="dv">9</span>, <span class="at">dist=</span><span class="st">'normal'</span>, <span class="at">mu=</span><span class="dv">0</span>, <span class="at">sigma=</span><span class="dv">1</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># make a grid of x, y points where x and y both take values from quad_points$nodes</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>m <span class="ot">=</span> <span class="dv">16</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>z1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(quad_points<span class="sc">$</span>nodes, m)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>z2 <span class="ot">&lt;-</span> <span class="fu">rep</span>(quad_points<span class="sc">$</span>nodes, <span class="at">each=</span>m)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co"># get evaluation points</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>Qz <span class="ot">&lt;-</span> Q <span class="sc">%*%</span> <span class="fu">rbind</span>(z1, z2)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> Qz[<span class="dv">1</span>,] <span class="sc">+</span> mle<span class="sc">$</span>intercept</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>y2 <span class="ot">&lt;-</span> Qz[<span class="dv">2</span>,] <span class="sc">+</span> mle<span class="sc">$</span>betahat</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>f1 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(b0, b1){</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    psi <span class="ot">&lt;-</span> b0 <span class="sc">+</span> x <span class="sc">*</span> b1 <span class="sc">+</span> o</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sum</span>((y <span class="sc">*</span> psi) <span class="sc">-</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(psi)))) </span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># + dnorm(b, 0, sd = sqrt(1/tau0), log = T) + dnorm(b0, 0, sd=10000, log=T))</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="co">#w &lt;- rep(quad_points$weights, m) * rep(quad_points$weights, each=m) - 0.5 * log(det(-H)) + 0.5 * nrow(H) * log(2*pi) +  logsumexp(f1(x2, y2) - C + log(w))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-19_cc090c081c2ae01d5f0d4ac11223150c">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#logsumexp(f1(x2, y2) + log(w))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-20_401e530d177cac2b528304b1c2e6e429">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>C <span class="ot">&lt;-</span> <span class="fu">f1</span>(mle<span class="sc">$</span>intercept, mle<span class="sc">$</span>betahat)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>f2 <span class="ot">&lt;-</span> <span class="cf">function</span>(b1){<span class="fu">Vectorize</span>(<span class="cf">function</span>(b0){<span class="fu">f1</span>(b0, b1)})}</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>f3 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(b1){</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">f2</span>(b1)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  g2 <span class="ot">&lt;-</span> <span class="fu">Exp</span>(<span class="fu">Shift</span>(g, C))</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">log</span>(<span class="fu">integrate</span>(g2, <span class="sc">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>)<span class="sc">$</span>value) <span class="sc">+</span> C)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="fu">Exp</span>(<span class="fu">Shift</span>(f3, C))</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="fu">log</span>(<span class="fu">integrate</span>(h, <span class="sc">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>)<span class="sc">$</span>value) <span class="sc">+</span> C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -573.6373</code></pre>
</div>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-21_0180040707aa7076c0bddbd7d128fcb5">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">integrate_intercept</span>(x, y, o, <span class="dv">1</span>, <span class="at">m_int=</span><span class="dv">64</span>, <span class="at">m=</span><span class="dv">64</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -585.3545</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(z1, z2)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x2, y2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-22_b9bab41eccfbc79d233b0250bb1a77e8">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>ridgefit <span class="ot">&lt;-</span> logisticsusie<span class="sc">:::</span><span class="fu">ridge</span>(x, y, o, <span class="at">prior_variance=</span><span class="dv">1</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>f1 <span class="ot">&lt;-</span> <span class="fu">log_joint2</span>(x, y, o, <span class="dv">1</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> ridgefit<span class="sc">$</span>mu <span class="sc">+</span> <span class="dv">4</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>f2 <span class="ot">&lt;-</span> <span class="cf">function</span>(b0){<span class="fu">f1</span>(<span class="at">b=</span>b, b0)}</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co"># adaptive quadrature</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>f3 <span class="ot">&lt;-</span> <span class="fu">Shift</span>(f2, ridgefit<span class="sc">$</span>ll)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="fu">log</span>(<span class="fu">integrate</span>(<span class="fu">Exp</span>(f3), <span class="sc">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>)<span class="sc">$</span>value)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>I <span class="ot">&lt;-</span> <span class="fu">integrate</span>(<span class="fu">Exp</span>(f3), <span class="sc">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="fu">log</span>(I<span class="sc">$</span>value) <span class="sc">+</span> ridgefit<span class="sc">$</span>ll</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="co"># gauss-hermite</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>b0 <span class="ot">&lt;-</span> ridgefit<span class="sc">$</span>intercept</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>psi <span class="ot">&lt;-</span> b0 <span class="sc">+</span> x <span class="sc">*</span> b</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>psi))</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="fu">sum</span>(mu <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> mu))</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="co"># function logq(b)</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>logq <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(x, <span class="at">mean=</span>b0, <span class="at">sd=</span><span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>tau), <span class="at">log=</span>T) </span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="fu">Diff</span>(f3, logq)</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>quad_points <span class="ot">&lt;-</span> statmod<span class="sc">::</span><span class="fu">gauss.quad.prob</span>(<span class="dv">9</span>, <span class="at">dist=</span><span class="st">'normal'</span>, <span class="at">mu=</span>b0, <span class="at">sigma=</span><span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>tau))</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>logZ <span class="ot">&lt;-</span> <span class="fu">logsumexp</span>(<span class="fu">h</span>(quad_points<span class="sc">$</span>nodes) <span class="sc">+</span> <span class="fu">log</span>(quad_points<span class="sc">$</span>weights)) <span class="sc">+</span> ridgefit<span class="sc">$</span>ll</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>logZ</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a><span class="fu">gauss_hermite</span>(f3, b0, var, <span class="dv">0</span>)</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a><span class="fu">log</span>(<span class="fu">sum</span>(<span class="fu">exp</span>(<span class="fu">f3</span>(quad_points<span class="sc">$</span>nodes)) <span class="sc">*</span> quad_points<span class="sc">$</span>weights))</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(f3, <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-jaakkolaVariationalApproachBayesian" class="csl-entry" role="doc-biblioentry">
Jaakkola, Tommi S, and Michael I Jordan. n.d. <span>“A Variational Approach to <span>Bayesian</span> Logistic Regression Models and Their Extensions.”</span> <em>Sixth International Workshop on Artificial Intelligence and Statistics</em>, 283–94.
</div>
<div id="ref-jackelNoteMultivariateGaussHermite" class="csl-entry" role="doc-biblioentry">
Jäckel, Peter. n.d. <span>“A Note on Multivariate <span>Gauss-Hermite</span> Quadrature.”</span>
</div>
<div id="ref-liuNoteGaussHermite1994" class="csl-entry" role="doc-biblioentry">
LIU, QING, and DONALD A. PIERCE. 1994. <span>“A Note on <span>Gauss</span>—<span>Hermite</span> Quadrature.”</span> <em>Biometrika</em> 81 (3): 624–29. <a href="https://doi.org/10.1093/biomet/81.3.624">https://doi.org/10.1093/biomet/81.3.624</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>